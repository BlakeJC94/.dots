#!/bin/bash

# enable 256 color support
set -g default-terminal "tmux-256color"
set -as terminal-features ",gnome*:RGB"
set -as terminal-overrides ",gnome*:Tc"

# Free up index 0 to move tabs to front
set -g base-index 1

# automatically renumber tmux windows
set -g renumber-windows on

# More responsive ESC
set -sg escape-time 20

# Use login shell (sources bashrc)
set-option -g default-shell "/usr/bin/bash"
set-option -g default-command bash

# mouse stuff
set -g mouse off

# Enable undercurls in kitty
# set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
# set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Set vi-mode copy keybinds
setw -g mode-keys vi
# set -g status-keys vi
# set -g set-clipboard off
# set -g mode-keys vi

# Set tab names to auto-refresh to base dir names
set-option -g status-interval 5
set-option -g automatic-rename on
set-option -g automatic-rename-format "#{=|-24|...;s|$HOME|~|:pane_current_path}"

######## MAPPINGS ########

# Remap tmux leader
unbind C-b
set -g prefix C-z
bind z send-keys C-z

# Reload
bind c source-file ~/.tmux.conf \; display-message 'Reloaded tmux config'

# Sessions
bind n new-session
bind R command-prompt -I "#W" "rename-session '%%'"
bind Q kill-session
bind Enter choose-tree

# Windows
bind t new-window -c "#{pane_current_path}"
bind \; command-prompt -I "#W" "rename-window '%%'"
bind Space resize-pane -Z
bind Tab last-window
bind BSpace command-prompt "find-window '%%'"
bind , previous-window
bind . next-window
bind -r < swap-window -t -1 \; previous-window
bind -r > swap-window -t +1 \; next-window

# Panes/splits
bind y next-layout
bind w display-panes
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
bind q kill-pane

# Mode
bind C-z copy-mode
bind -T copy-mode-vi i send -X cancel
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'

# Launchers
bind-key p new-window ncspot \; move-window -t 0 \; rename-window spotify

# Disable <C-z>+<arrow> accidental resizing
unbind -T prefix C-Up
unbind -T prefix C-Down
unbind -T prefix C-Left
unbind -T prefix C-Right

bind 'Left'  if -F '#{pane_at_left}'   '' 'select-pane -L'
bind h       if -F '#{pane_at_left}'   '' 'select-pane -L'
bind 'Down'  if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind j       if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind 'Up'    if -F '#{pane_at_top}'    '' 'select-pane -U'
bind k       if -F '#{pane_at_top}'    '' 'select-pane -U'
bind 'Right' if -F '#{pane_at_right}'  '' 'select-pane -R'
bind l       if -F '#{pane_at_right}'  '' 'select-pane -R'
# resize-pane
bind -n 'M-Left'  resize-pane -L 8
bind -n 'M-Down'  resize-pane -D 4
bind -n 'M-Up'    resize-pane -U 4
bind -n 'M-Right' resize-pane -R 8
# swap-pane
bind H splitw -fhb \; swapp -t ! \; killp -t !
bind L splitw -fh  \; swapp -t ! \; killp -t !
bind J splitw -fv  \; swapp -t ! \; killp -t !
bind K splitw -fvb \; swapp -t ! \; killp -t !
bind 'S-Left'  splitw -fhb \; swapp -t ! \; killp -t !
bind 'S-Down'  splitw -fh  \; swapp -t ! \; killp -t !
bind 'S-Up'    splitw -fv  \; swapp -t ! \; killp -t !
bind 'S-Right' splitw -fvb \; swapp -t ! \; killp -t !

# # select-pane
# # bind -n C-w switch-client -T ctrlw
# # bind -T ctrlw C-w send-keys C-w
# is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
# bind 'Left'  if-shell "$is_vim" 'send-keys C-z Left'  { if -F '#{pane_at_left}'   '' 'select-pane -L' }
# bind h       if-shell "$is_vim" 'send-keys C-z h'     { if -F '#{pane_at_left}'   '' 'select-pane -L' }
# bind 'Down'  if-shell "$is_vim" 'send-keys C-z Down'  { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
# bind j       if-shell "$is_vim" 'send-keys C-z j'     { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
# bind 'Up'    if-shell "$is_vim" 'send-keys C-z Up'    { if -F '#{pane_at_top}'    '' 'select-pane -U' }
# bind k       if-shell "$is_vim" 'send-keys C-z k'     { if -F '#{pane_at_top}'    '' 'select-pane -U' }
# bind 'Right' if-shell "$is_vim" 'send-keys C-z Right' { if -F '#{pane_at_right}'  '' 'select-pane -R' }
# bind l       if-shell "$is_vim" 'send-keys C-z l'     { if -F '#{pane_at_right}'  '' 'select-pane -R' }
# # bind -T copy-mode-vi 'Left'  if -F '#{pane_at_left}'   '' 'select-pane -L'
# # bind -T copy-mode-vi h       if -F '#{pane_at_left}'   '' 'select-pane -L'
# # bind -T copy-mode-vi 'Down'  if -F '#{pane_at_bottom}' '' 'select-pane -D'
# # bind -T copy-mode-vi j       if -F '#{pane_at_bottom}' '' 'select-pane -D'
# # bind -T copy-mode-vi 'Up'    if -F '#{pane_at_top}'    '' 'select-pane -U'
# # bind -T copy-mode-vi k       if -F '#{pane_at_top}'    '' 'select-pane -U'
# # bind -T copy-mode-vi 'Right' if -F '#{pane_at_right}'  '' 'select-pane -R'
# # bind -T copy-mode-vi l       if -F '#{pane_at_right}'  '' 'select-pane -R'
# # resize-pane
# bind -n 'M-Left'  if-shell "$is_vim" 'send-keys M-Left'  'resize-pane -L 8'
# bind -n 'M-Down'  if-shell "$is_vim" 'send-keys M-Down'  'resize-pane -D 4'
# bind -n 'M-Up'    if-shell "$is_vim" 'send-keys M-Up'    'resize-pane -U 4'
# bind -n 'M-Right' if-shell "$is_vim" 'send-keys M-Right' 'resize-pane -R 8'
# # bind -T copy-mode-vi 'M-Left'  resize-pane -L 8
# # bind -T copy-mode-vi 'M-Down'  resize-pane -D 4
# # bind -T copy-mode-vi 'M-Up'    resize-pane -U 4
# # bind -T copy-mode-vi 'M-Right' resize-pane -R 8
# # swap-pane
# bind H splitw -fhb \; swapp -t ! \; killp -t !
# bind L splitw -fh  \; swapp -t ! \; killp -t !
# bind J splitw -fv  \; swapp -t ! \; killp -t !
# bind K splitw -fvb \; swapp -t ! \; killp -t !
# bind 'S-Left'  splitw -fhb \; swapp -t ! \; killp -t !
# bind 'S-Down'  splitw -fh  \; swapp -t ! \; killp -t !
# bind 'S-Up'    splitw -fv  \; swapp -t ! \; killp -t !
# bind 'S-Right' splitw -fvb \; swapp -t ! \; killp -t !

# run-shell ~/.dots/ctrlw.tmux

######## THEME #######

# window separators
set-option -wg window-status-separator " "

# monitor window changes
set-option -wg monitor-activity on
set-option -wg monitor-bell on

# set statusbar update interval
set-option -g status-interval 1

### colorscheme ###

# change window screen colors
set-option -wg mode-style bg="#B8BB26",fg="#3C3836"

# default statusbar colors (terminal bg should be #282828)
set-option -g status-style bg=terminal,fg="#A89984"

# default window title colors
set-option -wg window-status-style bg="#3C3836",fg="#7C6F64"

# colors for windows with activity
set-option -wg window-status-activity-style bg="#3C3836",fg="#A89984"

# colors for windows with bells
set-option -wg window-status-bell-style bg="#3C3836",fg="#FE8019"

# active window title colors
set-option -wg window-status-current-style bg="#FE8019",fg="#3C3836"

# active window background
set -g window-active-style bg="#1D2021"
set -g window-style bg="#1D2021"
# set -g window-style bg="#12181A"

# pane border
set-option -g pane-border-lines double
set-option -g pane-active-border-style bg="#1D2021",fg="#A89984"
set-option -g pane-border-style bg="#1D2021",fg="#3C3839"
# set-option -g pane-active-border-style bg="#1D2021",fg="#1D2021"
# set-option -g pane-border-style bg="#12181A",fg="#12181A"

# message info
set-option -g message-style bg="#B8BB26",fg="#3C3836"

# writing commands inactive
set-option -g message-command-style bg="#A89984",fg="#3C3836"

# pane number display
set-option -g display-panes-active-colour "#FE8019"
set-option -g display-panes-colour "#3C3836"

# clock
set-option -wg clock-mode-colour "#FE8019"

# copy mode highlighting
%if #{>=:#{version},3.2}
    set-option -wg copy-mode-match-style "bg=#FABD2F,fg=#3C3836"
    set-option -wg copy-mode-current-match-style "bg=#A89984,fg=#3C3836"
%endif

# statusbar formatting
# "#fe8019" MUST be in lowercase here (conflicts with statusline alias otherwise)
set-option -g status-position bottom
set-option -g status-left "#[bg=#A89984, fg=#3C3836]#{?client_prefix,#[bg=#83a598],#[bg=#A89984]} #{session_name} #[bg=#1D2021,fg=#A89984,nobold,noitalics,nounderscore]#{?client_prefix,#[fg=#83a598],#[fg=#A89984]}#[bg=#1d2021, fg=#1d2021] "
set-option -g status-right "#[fg=#3C3839 nobold, nounderscore, noitalics]#[bg=#A89984, fg=#3C3836] %Y-%m-%d │ %H:%M "

set-option -wg window-status-current-format "#[bg=#3C3836,fg=#1D2021,nobold,noitalics,nounderscore]#[bg=#83a598, fg=#3C3839] #{window_index} #{?window_zoomed_flag,#[fg=#3C3839],#[fg=#3C3839]}#{window_name} #[bg=#1d2021, fg=#1d2021]"
set-option -wg window-status-format "#[bg=#504945, fg=#A89984,noitalics]#{?window_zoomed_flag,#[fg=#A89984 bold],#[fg=#A89984]} #{window_index} #{window_name} #[bg=#1D2021,fg=#3C3839,noitalics]"

# set-option -g status "on"
# # default statusbar color
# set-option -g status-style bg=colour237,fg=colour223 # bg=bg1, fg=fg1
# # default window title colors
# set-window-option -g window-status-style bg=colour214,fg=colour237 # bg=yellow, fg=bg1
# # default window with an activity alert
# set-window-option -g window-status-activity-style bg=colour237,fg=colour248 # bg=bg1, fg=fg3
# # active window title colors
# set-window-option -g window-status-current-style bg=red,fg=colour237 # fg=bg1
# # pane border
# set-option -g pane-active-border-style fg=colour250 #fg2
# set-option -g pane-border-style fg=colour237 #bg1
# # message infos
# set-option -g message-style bg=colour239,fg=colour223 # bg=bg2, fg=fg1
# # writing commands inactive
# set-option -g message-command-style bg=colour239,fg=colour223 # bg=fg3, fg=bg1
# # pane number display
# set-option -g display-panes-active-colour colour250 #fg2
# set-option -g display-panes-colour colour237 #bg1
# # clock
# set-window-option -g clock-mode-colour colour109 #blue
# # bell
# set-window-option -g window-status-bell-style bg=colour167,fg=colour235 # bg=red, fg=bg
# ## Theme settings mixed with colors (unfortunately, but there is no cleaner way)
# set-option -g status-justify "left"
# set-option -g status-left-style none
# set-option -g status-left-length "80"
# set-option -g status-right-style none
# set-option -g status-right-length "80"
# set-window-option -g window-status-separator ""
# set-option -g status-left "#[bg=colour241,fg=colour248] #S #[bg=colour237,fg=colour241,nobold,noitalics,nounderscore]"
# set-option -g status-right "#[bg=colour237,fg=colour239 nobold, nounderscore, noitalics]#[bg=colour239,fg=colour246] %Y-%m-%d  %H:%M #[bg=colour239,fg=colour248,nobold,noitalics,nounderscore]#[bg=colour248,fg=colour237] #h "
# set-window-option -g window-status-current-format "#[bg=colour214,fg=colour237,nobold,noitalics,nounderscore]#[bg=colour214,fg=colour239] #I #[bg=colour214,fg=colour239,bold] #W#{?window_zoomed_flag,*Z,} #[bg=colour237,fg=colour214,nobold,noitalics,nounderscore]"
# set-window-option -g window-status-format "#[bg=colour239,fg=colour237,noitalics]#[bg=colour239,fg=colour223] #I #[bg=colour239,fg=colour223] #W #[bg=colour237,fg=colour239,noitalics]"
# # set status-right " #{pane_index} "

