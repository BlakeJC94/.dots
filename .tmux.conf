#!/bin/bash

# enable 256 color support
set -g default-terminal "tmux-256color"

# Free up index 0 to move tabs to front
set -g base-index 1

# automatically renumber tmux windows
set -g renumber-windows on

# More responsive ESC
set -sg escape-time 0

# Use login shell (sources bashrc)
set-option -g default-shell "/usr/bin/bash"
set-option -g default-command bash

# Enable undercurls in kitty
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Set vi-mode copy keybinds
set -g status-keys vi
set -g set-clipboard off
set -g mode-keys vi


######## MAPPINGS ########

# Remap tmux leader to M-x
unbind C-b
set -g prefix M-x

# Reload
bind c source-file ~/.tmux.conf \; display-message 'Reloaded tmux config'

# Sessions
bind n new-session
bind R command-prompt -I "#W" "rename-session '%%'"
bind Q kill-session
bind Enter choose-tree

# Windows
bind t new-window -c "#{pane_current_path}"
bind q kill-window
bind Space command-prompt -I "#W" "rename-window '%%'"
bind Tab last-window
bind BSpace command-prompt "find-window '%%'"
bind , previous-window
bind . next-window
bind -r < swap-window -t -1 \; previous-window
bind -r > swap-window -t +1 \; next-window

# Panes/splits
bind v next-layout
bind w display-panes
bind |  split-window -h -c "#{pane_current_path}"
bind _  split-window -v -c "#{pane_current_path}"

# select-pane
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind 'Left'  if-shell "$is_vim" 'send-keys M-x Left'  { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind h       if-shell "$is_vim" 'send-keys M-x h'     { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind 'Down'  if-shell "$is_vim" 'send-keys M-x Down'  { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind j       if-shell "$is_vim" 'send-keys M-x j'     { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind 'Up'    if-shell "$is_vim" 'send-keys M-x Up'    { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind k       if-shell "$is_vim" 'send-keys M-x k'     { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind 'Right' if-shell "$is_vim" 'send-keys M-x Right' { if -F '#{pane_at_right}'  '' 'select-pane -R' }
bind l       if-shell "$is_vim" 'send-keys M-x l'     { if -F '#{pane_at_right}'  '' 'select-pane -R' }
bind -T copy-mode-vi 'Left'  if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -T copy-mode-vi h       if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -T copy-mode-vi 'Down'  if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi j       if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi 'Up'    if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -T copy-mode-vi k       if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -T copy-mode-vi 'Right' if -F '#{pane_at_right}'  '' 'select-pane -R'
bind -T copy-mode-vi l       if -F '#{pane_at_right}'  '' 'select-pane -R'
# resize-pane
bind -n 'S-Left'  if-shell "$is_vim" 'send-keys S-Left'  'resize-pane -L 8'
bind -n 'S-Down'  if-shell "$is_vim" 'send-keys S-Down'  'resize-pane -D 8'
bind -n 'S-Up'    if-shell "$is_vim" 'send-keys S-Up'    'resize-pane -U 8'
bind -n 'S-Right' if-shell "$is_vim" 'send-keys S-Right' 'resize-pane -R 8'
bind -T copy-mode-vi S-Left  resize-pane -L 8
bind -T copy-mode-vi S-Down  resize-pane -D 4
bind -T copy-mode-vi S-Up    resize-pane -U 4
bind -T copy-mode-vi S-Right resize-pane -R 8
# swap-pane
bind 'S-Left'  splitw -fhb \; swapp -t ! \; killp -t !
bind H         splitw -fhb \; swapp -t ! \; killp -t !
bind 'S-Down'  splitw -fv  \; swapp -t ! \; killp -t !
bind J         splitw -fv  \; swapp -t ! \; killp -t !
bind 'S-Up'    splitw -fvb \; swapp -t ! \; killp -t !
bind K         splitw -fvb \; swapp -t ! \; killp -t !
bind 'S-Right' splitw -fh  \; swapp -t ! \; killp -t !
bind L         splitw -fh  \; swapp -t ! \; killp -t !
bind -T copy-mode-vi 'S-Left'  splitw -fhb \; swapp -t ! \; killp -t !
bind -T copy-mode-vi H         splitw -fhb \; swapp -t ! \; killp -t !
bind -T copy-mode-vi 'S-Down'  splitw -fv  \; swapp -t ! \; killp -t !
bind -T copy-mode-vi J         splitw -fv  \; swapp -t ! \; killp -t !
bind -T copy-mode-vi 'S-Up'    splitw -fvb \; swapp -t ! \; killp -t !
bind -T copy-mode-vi K         splitw -fvb \; swapp -t ! \; killp -t !
bind -T copy-mode-vi 'S-Right' splitw -fh  \; swapp -t ! \; killp -t !
bind -T copy-mode-vi L         splitw -fh  \; swapp -t ! \; killp -t !

# Mode
bind Escape copy-mode
bind -T copy-mode-vi i send -X cancel
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'

# Launchers
bind-key p new-window ncspot \; move-window -t 0


######## THEME #######
set-option -g status "on"
# default statusbar color
set-option -g status-style bg=colour237,fg=colour223 # bg=bg1, fg=fg1
# default window title colors
set-window-option -g window-status-style bg=colour214,fg=colour237 # bg=yellow, fg=bg1
# default window with an activity alert
set-window-option -g window-status-activity-style bg=colour237,fg=colour248 # bg=bg1, fg=fg3
# active window title colors
set-window-option -g window-status-current-style bg=red,fg=colour237 # fg=bg1
# pane border
set-option -g pane-active-border-style fg=colour250 #fg2
set-option -g pane-border-style fg=colour237 #bg1
# message infos
set-option -g message-style bg=colour239,fg=colour223 # bg=bg2, fg=fg1
# writing commands inactive
set-option -g message-command-style bg=colour239,fg=colour223 # bg=fg3, fg=bg1
# pane number display
set-option -g display-panes-active-colour colour250 #fg2
set-option -g display-panes-colour colour237 #bg1
# clock
set-window-option -g clock-mode-colour colour109 #blue
# bell
set-window-option -g window-status-bell-style bg=colour167,fg=colour235 # bg=red, fg=bg
## Theme settings mixed with colors (unfortunately, but there is no cleaner way)
set-option -g status-justify "left"
set-option -g status-left-style none
set-option -g status-left-length "80"
set-option -g status-right-style none
set-option -g status-right-length "80"
set-window-option -g window-status-separator ""
set-option -g status-left "#[bg=colour241,fg=colour248] #S #[bg=colour237,fg=colour241,nobold,noitalics,nounderscore]"
set-option -g status-right "#[bg=colour237,fg=colour239 nobold, nounderscore, noitalics]#[bg=colour239,fg=colour246] %Y-%m-%d  %H:%M #[bg=colour239,fg=colour248,nobold,noitalics,nounderscore]#[bg=colour248,fg=colour237] #h "
set-window-option -g window-status-current-format "#[bg=colour214,fg=colour237,nobold,noitalics,nounderscore]#[bg=colour214,fg=colour239] #I #[bg=colour214,fg=colour239,bold] #W#{?window_zoomed_flag,*Z,} #[bg=colour237,fg=colour214,nobold,noitalics,nounderscore]"
set-window-option -g window-status-format "#[bg=colour239,fg=colour237,noitalics]#[bg=colour239,fg=colour223] #I #[bg=colour239,fg=colour223] #W #[bg=colour237,fg=colour239,noitalics]"
# set status-right " #{pane_index} "

