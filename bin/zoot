#!/bin/bash
# shellcheck shell=bash

# This is a portable script utility to deploy my dotfiles and install programs selectively
#

# TODO change "install" to "zoot"
ZOOTROOT="${HOME}/.dots/scripts/install"

usage() {
    cat 1>&2 <<EOF
zoot
The installer for .dots

[TODO] write a bit more documentation here

USAGE:
    zoot [OPTIONS]

OPTIONS:
    -h, --help                                     Show documentation
    -l, --list                                     Show which scripts are available
    -a, --all                                      Run all install scripts
EOF
}

get_scripts() {
    local root_dir
    local local_scripts
    local stem_dir
    local name

    root_dir=${1}
    stem_dir=${2}
    name=${3:-*}

    local_scripts=$(find "${root_dir}" -name "${name}.sh" -path "*/${stem_dir}/*")
    # echo "${local_scripts// /\\ }" | paste -sd " "
    # TODO error if there's files with spaces
    # TODO printf
    echo "${local_scripts}" | paste -sd " "
}

run_scripts() {
    local scripts_to_run
    scripts_to_run=$*

    for script in ${scripts_to_run}; do
        echo "==>==> $(basename ${script}) $(whoami)"
    done
}

main() {
    local requested
    for arg in "$@"; do
        case "$arg" in
            --help)
                usage
                exit 0
                ;;
            --list)
                MSG="requested list"
                ;;
            --all)
                MSG="requested all"
                ;;
            *)
                if [[ "$arg" =~ ^-- ]]; then
                    requested="${requested} ${arg:2}"
                else
                    while getopts :hla sub_arg "$arg"; do
                        case "$sub_arg" in
                            h)
                                usage
                                exit 0
                                ;;
                            l)
                                MSG="requested list"
                                ;;
                            a)
                                MSG="requested all"
                                ;;
                            *)
                                ;;
                            esac
                    done
                fi
                ;;
        esac
    done

    # MSG="${MSG} ${requested}"
    # echo "${MSG}"

    # I would need to parse all the remaining args..
    # TODO get list of scripts from user instructions
    # if --all:
    #     TODO declare what --all actually means
    # else:
    #    TODO match script names from user input
    #    TODO error if there's no matches

    # TODO link dotfiles

    # Install globals TODO filter
    # sudo apt update && sudo apt upgrade -y
    # sudo bash -c "for script in ${ZOOTROOT}/global/**; bash \$script; done"
    local global_scripts
    global_scripts=$(get_scripts "${ZOOTROOT}" "local" "")
    if [ -n "${global_scripts}" ]; then
        # sudo bash -c "$(declare -f run_scripts); run_scripts ${global_scripts}"
    fi

    # Install locals TODO filter
    local local_scripts
    local_scripts=$(get_scripts "${ZOOTROOT}" "local" "")
    if [ -n "${local_scripts}" ]; then
        # bash -c "$(declare -f run_scripts); run_scripts ${local_scripts}"
    fi

    echo "==> PASS!"
    return 0
}

main "$@" || exit 1
