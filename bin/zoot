#!/bin/sh
# shellcheck shell=bash

# This is a portable script utility to deploy my dotfiles and install programs selectively
#

# TODO change "install" to "zoot"
ZOOTROOT="${HOME}/.dots/scripts/install"

usage() {
    cat 1>&2 <<EOF
zoot
The installer for .dots

[TODO] write a bit more documentation here

USAGE:
    zoot [OPTIONS]

OPTIONS:
    -h, --help                                     Show documentation
    -l, --list                                     Show which scripts are available
    -a, --all                                      Run all install scripts
EOF
}

# get_all_scripts() {
#     local all_files
#     all_files=$(find "${ZOOTROOT}" -name "*.sh" -path "*/local/*" -o -path "*/global/*")
#     # check there's no spaces?
#     echo "${all_files}"
# }

get_local_scripts() {
    local root_dir
    local local_scripts
    root_dir=${1}
    local_scripts=$(find "${root_dir}" -name "*.sh" -path "*/local/*")
    echo "${local_scripts}"
}

get_global_scripts() {
    local global_scripts
    local root_dir
    root_dir=${1}
    global_scripts=$(find "${root_dir}" -name "*.sh" -path "*/global/*")
    echo "${global_scripts}"
}

run_scripts() {
    local scripts_to_run
    scripts_to_run=$*
    echo ${scripts_to_run}
    for script in ${scripts_to_run}; do
        # echo "foo"
        # bash "${script}"
        echo "${script}"
    done
}

main() {
    local requested
    for arg in "$@"; do
        case "$arg" in
            --help)
                usage
                exit 0
                ;;
            --list)
                MSG="requested list"
                ;;
            --all)
                MSG="requested all"
                ;;
            *)
                if [[ "$arg" =~ ^-- ]]; then
                    requested="${requested} ${arg:2}"
                else
                    while getopts :hla sub_arg "$arg"; do
                        case "$sub_arg" in
                            h)
                                usage
                                exit 0
                                ;;
                            l)
                                MSG="requested list"
                                ;;
                            a)
                                MSG="requested all"
                                ;;
                            *)
                                ;;
                            esac
                    done
                fi
                ;;
        esac
    done

    # MSG="${MSG} ${requested}"
    # echo "${MSG}"

    # I would need to parse all the remaining args..
    # TODO get list of scripts from user instructions
    # if --all:
    #     TODO declare what --all actually means
    # else:
    #    TODO match script names from user input
    #    TODO error if there's no matches

    # TODO link dotfiles

    # Install globals
    # sudo apt update && sudo apt upgrade -y
    # sudo bash -c "for script in ${ZOOTROOT}/global/**; bash \$script; done"

    # Install locals
    # bash -c "for script in ${ZOOTROOT}/local/**; bash \$script; done"

    echo "==> PASS!"
    return 0
}

main "$@" || exit 1
